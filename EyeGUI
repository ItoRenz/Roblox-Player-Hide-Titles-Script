-- Hide Player Titles Script (Mobile & PC Optimized)
-- Letakkan script ini sebagai LocalScript di StarterGui atau StarterPlayerScripts

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- Deteksi platform
local isMobile = UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled

-- Buat ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "HideTitlesGui"
screenGui.ResetOnSpawn = false
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
screenGui.Parent = PlayerGui

-- Ukuran berbeda untuk mobile dan PC
local buttonSize = isMobile and UDim2.new(0, 50, 0, 50) or UDim2.new(0, 45, 0, 45)
local buttonPosition = isMobile and UDim2.new(1, -70, 0, 15) or UDim2.new(1, -65, 0, 15)

-- Frame untuk toggle button
local toggleButton = Instance.new("TextButton")
toggleButton.Name = "ToggleButton"
toggleButton.Size = buttonSize
toggleButton.Position = buttonPosition
toggleButton.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
toggleButton.BorderSizePixel = 0
toggleButton.Text = ""
toggleButton.ZIndex = 10
toggleButton.Parent = screenGui

-- Rounded corners
local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 10)
corner.Parent = toggleButton

-- Shadow effect
local shadow = Instance.new("Frame")
shadow.Name = "Shadow"
shadow.Size = UDim2.new(1, 4, 1, 4)
shadow.Position = UDim2.new(0, -2, 0, -2)
shadow.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
shadow.BackgroundTransparency = 0.6
shadow.BorderSizePixel = 0
shadow.ZIndex = 9
shadow.Parent = toggleButton

local shadowCorner = Instance.new("UICorner")
shadowCorner.CornerRadius = UDim.new(0, 10)
shadowCorner.Parent = shadow

-- Icon mata
local eyeIcon = Instance.new("TextLabel")
eyeIcon.Name = "EyeIcon"
eyeIcon.Size = UDim2.new(0.75, 0, 0.75, 0)
eyeIcon.Position = UDim2.new(0.125, 0, 0.125, 0)
eyeIcon.BackgroundTransparency = 1
eyeIcon.Text = "üëÅ"
eyeIcon.TextColor3 = Color3.fromRGB(255, 255, 255)
eyeIcon.TextScaled = true
eyeIcon.Font = Enum.Font.GothamBold
eyeIcon.ZIndex = 11
eyeIcon.Parent = toggleButton

-- Garis silang untuk mode "hidden"
local crossLine = Instance.new("Frame")
crossLine.Name = "CrossLine"
crossLine.Size = UDim2.new(1.5, 0, 0, 3)
crossLine.Position = UDim2.new(-0.25, 0, 0.5, 0)
crossLine.AnchorPoint = Vector2.new(0, 0.5)
crossLine.BackgroundColor3 = Color3.fromRGB(255, 80, 80)
crossLine.BorderSizePixel = 0
crossLine.Rotation = 45
crossLine.Visible = false
crossLine.ZIndex = 12
crossLine.Parent = eyeIcon

local crossCorner = Instance.new("UICorner")
crossCorner.CornerRadius = UDim.new(1, 0)
crossCorner.Parent = crossLine

-- Status indicator (small dot)
local statusDot = Instance.new("Frame")
statusDot.Name = "StatusDot"
statusDot.Size = UDim2.new(0, 8, 0, 8)
statusDot.Position = UDim2.new(1, -10, 0, 2)
statusDot.BackgroundColor3 = Color3.fromRGB(80, 255, 120)
statusDot.BorderSizePixel = 0
statusDot.ZIndex = 12
statusDot.Parent = toggleButton

local dotCorner = Instance.new("UICorner")
dotCorner.CornerRadius = UDim.new(1, 0)
dotCorner.Parent = statusDot

-- Status variables
local isHidden = false
local hiddenObjects = {}
local isHovering = false

-- Fungsi untuk menyembunyikan semua GUI di kepala player
local function hidePlayerGui(character, hide)
    if not character then return end
    
    local success, err = pcall(function()
        local head = character:FindFirstChild("Head")
        if not head then return end
        
        -- Sembunyikan semua BillboardGui
        for _, descendant in pairs(character:GetDescendants()) do
            if descendant:IsA("BillboardGui") then
                if hide then
                    hiddenObjects[descendant] = descendant.Enabled
                    descendant.Enabled = false
                else
                    if hiddenObjects[descendant] ~= nil then
                        descendant.Enabled = hiddenObjects[descendant]
                        hiddenObjects[descendant] = nil
                    end
                end
            end
        end
        
        -- Sembunyikan nametag dan health bar default
        local humanoid = character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            if hide then
                humanoid.DisplayDistanceType = Enum.HumanoidDisplayDistanceType.None
            else
                humanoid.DisplayDistanceType = Enum.HumanoidDisplayDistanceType.Viewer
            end
        end
        
        -- Sembunyikan semua TextLabel dan TextButton di dalam Head
        for _, obj in pairs(head:GetDescendants()) do
            if obj:IsA("TextLabel") or obj:IsA("TextButton") or obj:IsA("TextBox") then
                if hide then
                    hiddenObjects[obj] = obj.Visible
                    obj.Visible = false
                else
                    if hiddenObjects[obj] ~= nil then
                        obj.Visible = hiddenObjects[obj]
                        hiddenObjects[obj] = nil
                    end
                end
            end
            
            -- Sembunyikan SurfaceGui
            if obj:IsA("SurfaceGui") then
                if hide then
                    hiddenObjects[obj] = obj.Enabled
                    obj.Enabled = false
                else
                    if hiddenObjects[obj] ~= nil then
                        obj.Enabled = hiddenObjects[obj]
                        hiddenObjects[obj] = nil
                    end
                end
            end
        end
    end)
    
    if not success and err then
        warn("Error in hidePlayerGui:", err)
    end
end

-- Fungsi toggle utama
local function toggleVisibility()
    isHidden = not isHidden
    
    -- Update tampilan button
    if isHidden then
        toggleButton.BackgroundColor3 = Color3.fromRGB(70, 40, 40)
        crossLine.Visible = true
        eyeIcon.TextColor3 = Color3.fromRGB(180, 180, 180)
        statusDot.BackgroundColor3 = Color3.fromRGB(255, 80, 80)
    else
        toggleButton.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
        crossLine.Visible = false
        eyeIcon.TextColor3 = Color3.fromRGB(255, 255, 255)
        statusDot.BackgroundColor3 = Color3.fromRGB(80, 255, 120)
    end
    
    -- Terapkan ke semua player
    for _, player in pairs(Players:GetPlayers()) do
        if player.Character then
            hidePlayerGui(player.Character, isHidden)
        end
    end
    
    -- Feedback haptic untuk mobile
    if isMobile then
        pcall(function()
            local HapticService = game:GetService("HapticService")
            HapticService:SetMotor(Enum.UserInputType.Gamepad1, Enum.VibrationMotor.Small, 0.5)
            task.wait(0.1)
            HapticService:SetMotor(Enum.UserInputType.Gamepad1, Enum.VibrationMotor.Small, 0)
        end)
    end
end

-- Fungsi untuk handle character baru
local function onCharacterAdded(character)
    if not character then return end
    
    local success, err = pcall(function()
        -- Tunggu semua GUI ter-load
        task.wait(0.5)
        
        if isHidden then
            hidePlayerGui(character, true)
        end
        
        -- Monitor perubahan pada character
        character.DescendantAdded:Connect(function(descendant)
            if isHidden then
                task.wait(0.1)
                pcall(function()
                    if descendant:IsA("BillboardGui") or descendant:IsA("SurfaceGui") then
                        descendant.Enabled = false
                    elseif descendant:IsA("TextLabel") or descendant:IsA("TextButton") or descendant:IsA("TextBox") then
                        local head = character:FindFirstChild("Head")
                        if head and descendant:IsDescendantOf(head) then
                            descendant.Visible = false
                        end
                    end
                end)
            end
        end)
    end)
    
    if not success and err then
        warn("Error in onCharacterAdded:", err)
    end
end

-- Event listeners
toggleButton.MouseButton1Click:Connect(toggleVisibility)

-- Handle semua player yang sudah ada
local function setupExistingPlayers()
    pcall(function()
        for _, player in pairs(Players:GetPlayers()) do
            if player.Character then
                onCharacterAdded(player.Character)
            end
            player.CharacterAdded:Connect(function(char)
                onCharacterAdded(char)
            end)
        end
    end)
end

-- Handle player baru yang join
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function(char)
        onCharacterAdded(char)
    end)
end)

-- Setup player yang sudah ada
setupExistingPlayers()

-- Animasi hover (hanya untuk PC)
if not isMobile then
    toggleButton.MouseEnter:Connect(function()
        isHovering = true
        toggleButton:TweenSize(UDim2.new(0, 50, 0, 50), Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.15, true)
    end)
    
    toggleButton.MouseLeave:Connect(function()
        isHovering = false
        toggleButton:TweenSize(UDim2.new(0, 45, 0, 45), Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.15, true)
    end)
end

-- Animasi klik
toggleButton.MouseButton1Down:Connect(function()
    local targetSize = isMobile and UDim2.new(0, 45, 0, 45) or UDim2.new(0, 42, 0, 42)
    toggleButton:TweenSize(targetSize, Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.1, true)
end)

toggleButton.MouseButton1Up:Connect(function()
    local targetSize = isMobile and UDim2.new(0, 50, 0, 50) or UDim2.new(0, 50, 0, 50)
    toggleButton:TweenSize(targetSize, Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.1, true)
    task.wait(0.1)
    
    -- Fix: Gunakan variable isHovering yang kita track sendiri
    if not isHovering and not isMobile then
        toggleButton:TweenSize(UDim2.new(0, 45, 0, 45), Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.15, true)
    elseif isMobile then
        toggleButton:TweenSize(UDim2.new(0, 50, 0, 50), Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.15, true)
    end
end)

print("‚úì Hide Player Titles loaded successfully!")
print("Platform:", isMobile and "Mobile" or "PC")
print("Toggle button created at top-right corner")
